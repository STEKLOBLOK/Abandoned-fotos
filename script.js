// ============================================
// АТОМ-5: ВИЗУАЛЬНАЯ НОВЕЛЛА
// Полная версия с 5 главами
// ============================================

// ========== ГЛОБАЛЬНОЕ СОСТОЯНИЕ ИГРЫ ==========
const gameState = {
    // Прогресс
    currentChapter: 0,
    currentStep: 0,
    totalChoices: 0,
    
    // Статистика
    karma: 50,           // 0-100 (доверие системы)
    documents: 0,        // найденные секретные документы
    keyItems: [],        // ключевые предметы
    endingsUnlocked: [], // разблокированные концовки
    
    // Флаги сюжета
    flags: {
        metOldMan: false,
        knowsAboutTunnel: false,
        warnedAboutAccident: false,
        suspicious: false,
        trusted: false,
        knowsSecret: false
    },
    
    // Инвентарь
    inventory: {
        pass: true,      // пропуск
        notebook: false, // блокнот старика
        keyCard: false,  // ключ-карта
        dosimeter: false,// дозиметр
        photo: false     // фотография
    }
};

// ========== ДАННЫЕ ГЛАВ ==========
const chapters = [
    // ========== ГЛАВА 1: ПРИБЫТИЕ ==========
    {
        id: 0,
        title: "Прибытие",
        location: "КПП 'Северный', въезд в Атом-5",
        datetime: "17 АПРЕЛЯ 1981, 06:30",
        steps: [
            {
                id: 0,
                text: `АВТОБУС "ИКАРУС" ГЛУШИТ ДВИГАТЕЛЬ.[[DELAY:800]][[IMG:img/start.jpg]][[DELAY:400]]\n\nСквозь утренний туман прорезаются огни контрольно-пропускного пункта.\n\nВы — ИГОРЬ СЕМЁНОВ, 24 года. Молодой инженер-электронщик, распределённый на АРТЗ после Московского института. В кармане — пропуск с грифом "Совершенно секретно" и пожелтевшее письмо от отца, который работал здесь в 60-х: "Городищево — наш дом. И наша тюрьма. Будь осторожен".\n\nСолдат в шинели стучит костяшками пальцев по стеклу. Его лицо не выражает ничего, кроме усталости от ночной смены.`,
                choices: [
                    { text: "Молча протянуть пропуск и документы", nextStep: 1, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "«Здравия желаю, товарищ старшина! Прибыл по распределению на АРТЗ»", nextStep: 2, karma: +5, effect: () => { gameState.totalChoices++; gameState.flags.trusted = true; } },
                    { text: "Спросить: «Далеко до общежития? Где тут можно позавтракать?»", nextStep: 3, karma: -10, effect: () => { gameState.totalChoices++; gameState.flags.suspicious = true; } }
                ]
            },
            {
                id: 1,
                text: `Солдат безучастно изучает ваш пропуск под ультрафиолетовой лампой. Слышен тихий щелчок фотоаппарата — ваше лицо фиксируют для архива.\n\n«Семёнов...» — бормочет он, сверяясь со списком. — «Сын Николая Семёнова? Тот, что в 67-м...» Он обрывает фразу. «Проходите. Автобус на площадь отходит через семь минут. Не сворачивайте с маршрута. Городской автобус №5, жёлтый».\n\nОн возвращает документы. В его глазах — что-то вроде... жалости?`,
                choices: [
                    { text: "Сесть в указанный автобус", nextStep: 4, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "«А что про моего отца? Он что-то натворил?»", nextStep: 5, karma: -15, effect: () => { gameState.totalChoices++; gameState.flags.suspicious = true; } },
                    { text: "Осмотреться вокруг КПП, пока ждёте автобус", nextStep: 6, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 2,
                text: `Солдат едва заметно кивает — редкое одобрение. «Так точно, товарищ инженер. Ваш отец, Николай Семёнов, был хорошим специалистом. На заводе его помнят».\n\nОн быстро проверяет документы. «На площади получите ордер на жильё в паспортном столе, дом №15 по улице Курчатова. Автобус сейчас подойдёт. Удачи на новом месте».\n\nВы замечаете, как он делает пометку в журнале зелёной ручкой — вроде как хороший знак.`,
                choices: [
                    { text: "Поблагодарить и сесть в автобус", nextStep: 4, karma: +5, effect: () => { gameState.totalChoices++; gameState.karma += 5; } },
                    { text: "«Спасибо. А почему отец уехал отсюда в 67-м?»", nextStep: 7, karma: -5, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 3,
                text: `Солдат хмурится. «Товарищ инженер, вы в закрытом городе, а не в доме отдыха. Дисциплина — прежде всего. Ваше жильё определит паспортный стол. По поводу завтрака — столовая №3 на площади открывается в 7:30».\n\nОн дольше обычного изучает ваши документы, переписывает данные в отдельный блокнот. Чувствуется, что вы попали в список «внимательных».`,
                choices: [
                    { text: "Извиниться и сесть в автобус", nextStep: 4, karma: -5, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 4,
                text: `Автобус почти пуст. Запотевшие стёкла, запах махорки и старой обивки. Вы садитесь у окна. За ним медленно проплывают серые панельные девятиэтажки, похожие на бетонные монолиты. Город просыпается: где-то вдалеке гудят громкоговорители с утренней гимнастикой.\n\nНапротив вас — пожилой мужчина в очках и потрёпанном плаще. Он пристально смотрит на вас, затем отводит взгляд.`,
                choices: [
                    { text: "Сделать вид, что спите", nextStep: 8, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Кивнуть в знак приветствия", nextStep: 9, karma: +3, effect: () => { gameState.totalChoices++; gameState.flags.metOldMan = true; } },
                    { text: "«Вы на меня что-то хотели?» — спросить напрямую", nextStep: 10, karma: -5, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 5,
                text: `Лицо солдата каменеет. «Не ваше дело, товарищ. Проходите». Он отдаёт документы и отворачивается, явно давая понять, что разговор окончен.\n\nВы чувствуете, что нажили себе проблемы в первый же день. В кармане будто тяжелеет письмо от отца...`,
                choices: [
                    { text: "Молча сесть в автобус", nextStep: 4, karma: -10, effect: () => { gameState.totalChoices++; gameState.karma -= 10; } }
                ]
            },
            {
                id: 6,
                text: `Вы отходите на несколько шагов. Вокруг КПП — бетонные ежи, ряды колючей проволоки, вышка с пулемётом. Из динамика тихо шипит радио «Маяк» — передают прогноз погоды.\n\nИ тут вы замечаете нечто странное: за вторым забором, в тумане, стоит необычно высокая антенна. Она отличается от обычных радиовышок — более массивная, с несколькими параболическими отражателями. Солдат следит за вашим взглядом.\n\n«Не рассматривайте, товарищ. Это не для ваших глаз», — говорит он без эмоций.`,
                choices: [
                    { text: "Вернуться к автобусу", nextStep: 4, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "«А что это? Для связи?»", nextStep: 11, karma: -10, effect: () => { gameState.totalChoices++; gameState.flags.suspicious = true; } }
                ]
            },
            {
                id: 7,
                text: `Солдат вздыхает. «67-й год... Была проверка из Москвы. Многие тогда уехали. Не спрашивайте больше». Он отдаёт документы. «Ваш автобус».`,
                choices: [
                    { text: "Сесть в автобус", nextStep: 4, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 8,
                text: `Вы прикрываете глаза. Через минуту чувствуете, как мужчина встаёт и выходит на остановке «Улица Энтузиастов». На сиденье он оставил потрёпанный кожаный блокнот.`,
                choices: [
                    { text: "Взять блокнот", nextStep: 12, karma: -5, effect: () => { gameState.totalChoices++; gameState.inventory.notebook = true; gameState.documents++; } },
                    { text: "Оставить блокнот", nextStep: 13, karma: +5, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 9,
                text: `Мужчина кивает в ответ. «Новый? На завод?» — спрашивает он негромко, оглядываясь по сторонам.`,
                choices: [
                    { text: "«Да, на АРТЗ. А вы?»", nextStep: 14, karma: +5, effect: () => { gameState.totalChoices++; gameState.flags.metOldMan = true; } },
                    { text: "«Это служебная информация»", nextStep: 15, karma: -10, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 10,
                text: `Мужчина морщится. «Извините. Вы напомнили мне одного человека». Он быстро выходит на следующей остановке, оставив на сиденье блокнот.`,
                choices: [
                    { text: "Взять блокнот", nextStep: 12, karma: -5, effect: () => { gameState.totalChoices++; gameState.inventory.notebook = true; gameState.documents++; } },
                    { text: "Оставить блокнот", nextStep: 13, karma: +5, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 11,
                text: `Солдат делает шаг в вашу сторону. «Товарищ инженер, последнее предупреждение: не проявляйте излишнего любопытства. Или я вынужден буду составить рапорт». Его рука лежит на кобуре.\n\nВы быстро садитесь в автобус.`,
                choices: [
                    { text: "Ехать молча", nextStep: 4, karma: -15, effect: () => { gameState.totalChoices++; gameState.karma -= 15; } }
                ]
            },
            {
                id: 12,
                text: `Вы незаметно суёте блокнот в сумку. На первой странице — странные схемы, расчёты и пометка: «ОКО-12. Частота 17.04. Замеры не сходятся. Возможно, влияние АЭС?»\n\nДалее идут координаты и непонятные символы. Автор — «В.К.»\n\nАвтобус выезжает на центральную площадь.`,
                choices: [
                    { text: "Сойти на площади", nextStep: 16, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 13,
                text: `Вы оставляете блокнот на сиденье. Возможно, это было правильно — меньше проблем.\n\nАвтобус выезжает на центральную площадь.`,
                choices: [
                    { text: "Сойти на площади", nextStep: 16, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 14,
                text: `«Я? Да я тут со времён, когда это был ещё медный завод Городищево» — он вздыхает. — «Теперь вот, в НИИ бумажки перекладываю. Совет молодому: на АРТЗ не задавай лишних вопросов про цех №2. И держись подальше от северного полигона по средам».`,
                choices: [
                    { text: "«Почему? Что там?»", nextStep: 17, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Поблагодарить за совет", nextStep: 18, karma: +10, effect: () => { gameState.totalChoices++; gameState.flags.warnedAboutAccident = true; } }
                ]
            },
            {
                id: 15,
                text: `Лицо мужчина каменеет. «Правильно. Забудь, что я спросил». Он резко отворачивается к окну. На следующей остановке выходит, хлопнув дверью.\n\nАвтобус продолжает путь.`,
                choices: [
                    { text: "Ехать дальше", nextStep: 16, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 16,
                text: `ПЛОЩАДЬ ЛЕНИНА. [[DELAY:800]][[IMG:img/lenin.jpg]][[DELAY:400]]\n\nТуман рассеивается, открывая вид на монументальную статую вождя, ДК «Энергия» с огромными буквами и длинную серую панель горкома.\n\nЛюди спешат на работу. Из динамиков доносится бодрый голос диктора: «...перевыполним план первого квартала!»\n\nВы стоите с чемоданом, разглядывая свой новый дом. Город Атом-5.`,
                choices: [
                    { text: "Найти паспортный стол (дом №15)", nextStep: 19, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Осмотреть площадь подробнее", nextStep: 20, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 17,
                text: `Мужчина понижает голос до шёпота: «Потому что по средам там... тестируют что-то новое. И иногда случаются... сбои. Месяц назад двоих отвезли в медсанчасть с ожогами. Не радиационными, а... другими». Он выглядит встревоженным.\n\n«Моя остановка». Он встаёт и на прощание говорит: «Ищи Василия Кротова в архивном отделе. Если захочешь узнать правду».\n\nОн выходит, оставив блокнот на сиденье.`,
                choices: [
                    { text: "Взять блокнот", nextStep: 12, karma: -5, effect: () => { gameState.totalChoices++; gameState.inventory.notebook = true; gameState.documents++; gameState.flags.knowsAboutTunnel = true; } },
                    { text: "Оставить блокнот", nextStep: 13, karma: +10, effect: () => { gameState.totalChoices++; gameState.flags.warnedAboutAccident = true; } }
                ]
            },
            {
                id: 18,
                text: `«Умный парень» — кивает старик. «Выживешь». Он протягивает вам маленький значок — стилизованное изображение атома. «Носи. Здесь свои узнают по таким мелочам».\n\nОн выходит. Вы получаете значок «Атом-5».`,
                choices: [
                    { text: "Продолжить путь", nextStep: 16, karma: +10, effect: () => { gameState.totalChoices++; gameState.keyItems.push('badge'); gameState.flags.trusted = true; } }
                ]
            },
            {
                id: 19,
                text: `ДОМ №15 — типичная панельная девятиэтажка. Паспортный стол на первом этаже. Очередь из трёх человек.\n\nЧерез двадцать минут вы получаете ордер на комнату в общежитии №4, удостоверение личности жителя Атом-5 и талоны на питание в столовой №3.\n\n«Завтра в 7:30 явка на АРТЗ, проходная №2. Инструктаж» — говорит уставшая женщина за стеклом.\n\nВы выходите на улицу. Первый день в закрытом городе начинается.`,
                choices: [
                    { text: "ЗАВЕРШИТЬ ГЛАВУ", nextStep: -1, karma: 0, effect: () => { endChapter(); } }
                ]
            },
            {
                id: 20,
                text: `Вы осматриваете площадь. Справа — ДК «Энергия» с афишей: сегодня вечером концерт ансамбля «Мечта». Слева — универмаг с очередью за колбасой. Прямо — здание горкома с лозунгом «СЛАВА КПСС!».\n\nЗамечаете молодую женщину с ребёнком. Она плачет, разговаривая с милиционером: «...муж не вернулся со смены, уже третьи сутки...» Милиционер успокаивает её: «На полигоне учения, связь временно отключена...»\n\nЧто-то в его тоне звучит фальшиво.`,
                choices: [
                    { text: "Подойти, предложить помощь", nextStep: 21, karma: +5, effect: () => { gameState.totalChoices++; } },
                    { text: "Пройти мимо, не вмешиваться", nextStep: 22, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 21,
                text: `Женщина смотрит на вас испуганными глазами. «Вы... вы новый? Не надо, всё в порядке...» — она быстро уходит, увлекая ребёнка.\n\nМилиционер смотрит на вас оценивающе. «Товарищ, не стоит интересоваться чужими делами. Идите по своим».`,
                choices: [
                    { text: "Извиниться и уйти", nextStep: 19, karma: -5, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 22,
                text: `Вы проходите мимо, делая вид, что не слышите. Но слова женщины засели в голове: «третьи сутки...»\n\nНаправляетесь в паспортный стол.`,
                choices: [
                    { text: "Получить документы", nextStep: 19, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            }
        ]
    },

    // ========== ГЛАВА 2: АРТЗ. ПЕРВАЯ СМЕНА ==========
    {
        id: 1,
        title: "АРТЗ. Первая смена",
        location: "Атомский Радиотехнический Завод, цех №1",
        datetime: "18 АПРЕЛЯ 1981, 07:45",
        steps: [
            {
                id: 0,
                text: `ПРОХОДНАЯ №2. [[DELAY:800]][[IMG:img/zavod.jpg]][[DELAY:400]]\n\nОчередь из рабочих в синих робах. Вы в новенькой форме инженера-технолога — белый халат, бейдж с фото.\n\n«Семёнов И.Н., цех №1, участок пайки» — читает охранник. Он сверяет ваше лицо с фотографией в журнале. «Знакомьтесь с мастером Сергеем Петровичем. Он вас всему научит».\n\nЩелчок турникета. Вы внутри завода.`,
                choices: [
                    { text: "Спросить дорогу к цеху №1", nextStep: 1, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Осмотреться в холле", nextStep: 2, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 1,
                text: `«Прямо, потом налево, второй корпус» — кивает охранник.\n\nКоридоры завода напоминают лабиринт: бетонные стены, трубы под потолком, резкий запах канифоли и кислоты. На стенах — плакаты: «ТБ — прежде всего!», «План — закон!»\n\nВы находите цех №1. Огромное помещение, заставленное столами с паяльными станциями. Десятки людей в белых халатах, приглушённый гул вентиляции.`,
                choices: [
                    { text: "Найти мастера", nextStep: 3, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 2,
                text: `Холл проходной украшен стендом «Передовики производства». Фотографии ударников труда. Среди них замечаете знакомое лицо — тот самый старик из автобуса! Подпись: «Кротов В.И., инженер 1-й категории, ветеран завода».\n\nРядом — карта завода с грифом «Для служебного пользования». Цех №2 отмечен красным, к нему ведёт тоннель под названием «Путь-9К».`,
                choices: [
                    { text: "Запомнить расположение цеха №2", nextStep: 1, karma: 0, effect: () => { gameState.totalChoices++; gameState.flags.knowsAboutTunnel = true; } }
                ]
            },
            {
                id: 3,
                text: `Мастер Сергей Петрович — мужчина лет 50, с усталым лицом и проницательными глазами. «А, Семёнов. Сын Николая? Похож».\n\nОн проводит вас по цеху. «У нас два производства: гражданское и специальное. Гражданское — телевизоры «Электрон», радиоприёмники. Специальное — вот эти платы» — он указывает на стол с зелёными текстолитовыми платами сложной формы.\n\n«Сегодня будешь помогать на гражданском. Пайка блоков развёртки. Инструкция на столе».`,
                choices: [
                    { text: "Спросить про специальные платы", nextStep: 4, karma: -10, effect: () => { gameState.totalChoices++; gameState.flags.suspicious = true; } },
                    { text: "Молча приступить к работе", nextStep: 5, karma: +5, effect: () => { gameState.totalChoices++; } },
                    { text: "«А где цех №2? Что там делают?»", nextStep: 6, karma: -20, effect: () => { gameState.totalChoices++; gameState.flags.suspicious = true; gameState.karma -= 10; } }
                ]
            },
            {
                id: 4,
                text: `Мастер хмурится. «Молодой, здесь не любят любопытных. Делай, что сказано. Остальное — не твоё дело». Он отворачивается, явно недовольный.\n\nВы начинаете работу. Паяльник, припой, платы. Монотонно, но требует внимания.`,
                choices: [
                    { text: "Работать молча", nextStep: 7, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 5,
                text: `«Умный парень» — одобрительно кивает мастер. «Твой отец тоже не лез, куда не надо. Поэтому и прожил долго».\n\nОн показывает приёмы пайки. «Важно не перегреть микросхему. И следи за вентиляцией — пары свинца».\n\nВы работаете. Через пару часов начинаете понимать ритм цеха.`,
                choices: [
                    { text: "Продолжить работу", nextStep: 7, karma: +5, effect: () => { gameState.totalChoices++; gameState.karma += 5; } }
                ]
            },
            {
                id: 6,
                text: `Лицо мастера становится каменным. «Семёнов, ко мне в кабинет». Он ведёт вас в маленькую комнату, закрывает дверь.\n\n«Слушай внимательно. Цех №2 — не твой уровень допуска. Даже я там не бывал. Там работают люди с особыми пропусками. И они... не такие, как мы. Больше вопросов не задавай. Понятно?»\n\nВ его голосе — неподдельный страх.`,
                choices: [
                    { text: "«Понял. Извините»", nextStep: 5, karma: -10, effect: () => { gameState.totalChoices++; } },
                    { text: "«А что значит «не такие»?»", nextStep: 8, karma: -30, effect: () => { gameState.totalChoices++; gameState.flags.suspicious = true; gameState.karma -= 20; } }
                ]
            },
            {
                id: 7,
                text: `ОБЕДЕННЫЙ ПЕРЕРЫВ. Столовая завода. Очередь за борщом и компотом. Вы садитесь за столик с двумя рабочими.\n\n«Новый? Из Москвы?» — спрашивает один. «Да» — отвечаете вы.\n\n«А я местный, с Городищево ещё. Помню, как этот завод строили в 50-х» — говорит второй. «Тогда и тоннель к части рыли. Говорят, он до сих пор используется».\n\nПервый рабочий бьёт его по плечу: «Молчи, дурак!»`,
                choices: [
                    { text: "«Какой тоннель?»", nextStep: 9, karma: -5, effect: () => { gameState.totalChoices++; } },
                    { text: "Промолчать, продолжать есть", nextStep: 10, karma: +5, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 8,
                text: `Мастер бледнеет. «Вон из моего кабинета. И забудь этот разговор. Если хочешь жить».\n\nОн выходит, оставляя вас в одиночестве. Через минуту возвращается охранник: «Товарищ Семёнов, с вами хочет поговорить товарищ из особого отдела».\n\nЭто не вопрос, а приказ.`,
                choices: [
                    { text: "Пойти с охранником", nextStep: 11, karma: -20, effect: () => { gameState.totalChoices++; gameState.flags.suspicious = true; } }
                ]
            },
            {
                id: 9,
                text: `Рабочие замолкают. «Тебе что, жить надоело?» — шипит первый. «Извини, парень, мы ничего не говорили».\n\nОни быстро собираются и уходят, оставив вас за столом в одиночестве. Остальные работники смотрят на вас с подозрением.`,
                choices: [
                    { text: "Вернуться в цех", nextStep: 12, karma: -10, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 10,
                text: `Вы делаете вид, что не слышали. Рабочие продолжают говорить уже шёпотом, бросая на вас настороженные взгляды.\n\n«...в среду опять вывозили что-то на полигон...»\n«...а Кротов говорил, что показания приборов...»\n«...замолчи, идёт начальник смены...»\n\nВ столовую входит суровый мужчина в форме. Все замолкают.`,
                choices: [
                    { text: "Закончить обед и выйти", nextStep: 12, karma: +5, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 11,
                text: `КАБИНЕТ ОСОБОГО ОТДЕЛА. Маленькая комната без окон. За столом — капитан с бесстрастным лицом.\n\n«Семёнов Игорь Николаевич. Сын Николая Семёнова, уволенного в 1967 году по статье...» — он смотрит на вас. «Вы задавали вопросы о цехе №2. Почему?»\n\nНа столе лежит ваше личное дело. Толстая папка.`,
                choices: [
                    { text: "«Просто интересовался структурой завода»", nextStep: 13, karma: -10, effect: () => { gameState.totalChoices++; } },
                    { text: "«Мастер сам заговорил об этом»", nextStep: 14, karma: -20, effect: () => { gameState.totalChoices++; } },
                    { text: "«Мой отец работал здесь. Хочу знать правду»", nextStep: 15, karma: -30, effect: () => { gameState.totalChoices++; gameState.flags.suspicious = true; } }
                ]
            },
            {
                id: 12,
                text: `ВТОРАЯ ПОЛОВИНА СМЕНЫ. Вы возвращаетесь к пайке. Мастер избегает смотреть на вас.\n\nВ 15:30 происходит странное: все рабочие вдруг прекращают работу, смотрят на часы. Раздаётся гудок — не обычный, а какой-то особенный, тревожный.\n\n«Объект транспортируют» — шепчет женщина за соседним столом. «Опять в среду...»\n\nЧерез окно цеха видно, как из цеха №2 выезжает бронированный грузовик в сопровождении военных. Он направляется к северным воротам.`,
                choices: [
                    { text: "Спросить, что это", nextStep: 16, karma: -5, effect: () => { gameState.totalChoices++; } },
                    { text: "Продолжать работать, не обращать внимания", nextStep: 17, karma: +5, effect: () => { gameState.totalChoices++; } },
                    { text: "Запомнить время и маршрут", nextStep: 18, karma: 0, effect: () => { gameState.totalChoices++; gameState.flags.knowsAboutTunnel = true; } }
                ]
            },
            {
                id: 13,
                text: `Капитан смотрит на вас долгим взглядом. «Любопытство — не порок, товарищ Семёнов. Но здесь оно может быть опасно для здоровья. Очень опасно».\n\nОн делает пометку в деле. «Возвращайтесь в цех. И помните: следующий разговор будет последним».\n\nВас отпускают.`,
                choices: [
                    { text: "Вернуться в цех", nextStep: 12, karma: -15, effect: () => { gameState.totalChoices++; gameState.karma -= 15; } }
                ]
            },
            {
                id: 14,
                text: `«Мастер Петров знает правила» — говорит капитан. «Он получит выговор. А вы... получите предупреждение. Вот» — он протягивает бумагу. «Подпись о неразглашении. Или увольнение по статье».\n\nВы подписываете.`,
                choices: [
                    { text: "Вернуться в цех", nextStep: 12, karma: -25, effect: () => { gameState.totalChoices++; gameState.karma -= 25; } }
                ]
            },
            {
                id: 15,
                text: `Капитан встаёт. «Правда? Вы хотите правды? Хорошо».\n\nОн открывает сейф, достаёт фотографию. На ней — ваш отец, молодой, в форме. Стоит у входа в какое-то подземное сооружение.\n\n«Ваш отец был в группе, которая строила «Путь-9К». Он... увидел то, чего не должен был. Мы предложили ему молчание в обмен на жизнь. Он согласился. И уехал».\n\nКапитан сжигает фотографию в пепельнице. «Теперь и вы видели. Выбор за вами: молчать или исчезнуть. Решайте».\n\nОн выходит, оставляя вас наедине с мыслями.`,
                choices: [
                    { text: "Поклясться молчать", nextStep: 19, karma: -40, effect: () => { gameState.totalChoices++; gameState.flags.knowsSecret = true; } },
                    { text: "Отказаться молчать", nextStep: 20, karma: -50, effect: () => { gameState.totalChoices++; gameState.flags.suspicious = true; gameState.karma -= 40; } }
                ]
            },
            {
                id: 16,
                text: `«Не твоё дело!» — резко обрывает мастер. «Работай!»\n\nВсе опускают головы, продолжают работу. Но напряжение висит в воздухе.`,
                choices: [
                    { text: "Продолжить работу", nextStep: 17, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 17,
                text: `Вы паяете очередную плату. Но мысли возвращаются к грузовику, к цеху №2, к словам капитана...\n\nСМЕНА ЗАКОНЧЕНА. Вы сдаёте инструмент, проходите через рамку детектора металла (она почему-то не пищит, хотя у вас в кармане ключ от общежития).\n\n«До завтра, Семёнов» — говорит охранник на проходной. В его взгляде что-то новое... уважение? Или опасение?`,
                choices: [
                    { text: "Вернуться в общежитие", nextStep: 21, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 18,
                text: `Вы запоминаете: 15:30, среда, грузовик ЗиЛ-131 с номером 042, северные ворота. Маршрут — вдоль забора к военной части.\n\nРаботаете дальше, делая вид, что ничего не заметили.\n\nСмена заканчивается.`,
                choices: [
                    { text: "Выйти с завода", nextStep: 21, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 19,
                text: `Вы возвращаетесь в цех. Мастер смотрит на вас с сочувствием. «Теперь ты один из нас» — говорит он тихо. «Держись, парень».\n\nОставшуюся смену работаете молча. В 16:00 — конец рабочего дня.`,
                choices: [
                    { text: "Уйти с завода", nextStep: 21, karma: -30, effect: () => { gameState.totalChoices++; gameState.karma -= 30; } }
                ]
            },
            {
                id: 20,
                text: `Капитан возвращается. «Жаль. Вы похожи на отца — такой же принципиальный».\n\nОн вызывает двух охранников. «Товарищ Семёнов направляется на внеплановый медицинский осмотр. В изолятор».\n\nВас выводят через чёрный ход. Конец главы?`,
                choices: [
                    { text: "...", nextStep: -2, karma: -100, effect: () => { gameState.totalChoices++; gameState.karma = 0; } }
                ]
            },
            {
                id: 21,
                text: `ВЕЧЕР. Вы идёте по улице Курчатова к общежитию. Город живёт своей жизнью: дети играют в песочнице, пенсионеры сидят на лавочках, из открытых окон доносится «Голубой огонёк».\n\nНо теперь вы видите другое: камеры наблюдения на столбах, патрули милиции, закрытые шторы на окнах некоторых квартир.\n\nВ кармане ноутбук Кротова жжёт, как уголь. А в голове — слова капитана: «молчать или исчезнуть».\n\nВы подходите к общежитию. Первый рабочий день в Атом-5 окончен.`,
                choices: [
                    { text: "ЗАВЕРШИТЬ ГЛАВУ", nextStep: -1, karma: 0, effect: () => { endChapter(); } }
                ]
            }
        ]
    },

    // ========== ГЛАВА 3: РЛК «ОКО-12» ==========
    {
        id: 2,
        title: "РЛК «ОКО-12»",
        location: "Военная часть 5543, северный сектор",
        datetime: "22 АПРЕЛЯ 1981, 14:00",
        steps: [
            {
                id: 0,
                text: `ПЯТЬ ДНЕЙ СПУСТЯ. Вы освоились на заводе. Работаете исправно, вопросов не задаёте. Мастер Петров стал относиться к вам лучше.\n\nСегодня среда. После обеда мастер отзывает вас: «Семёнов, нужно отвезти документацию в часть. Ты свободен после 14:00?»\n\nЭто не вопрос, а приказ. Вам вручают папку с грифом «Секретно» и пропуск в военную зону.`,
                choices: [
                    { text: "«Куда именно?»", nextStep: 1, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "«Есть!» — взять папку", nextStep: 2, karma: +5, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 1,
                text: `«В штаб части, к майору Орлову. Пропуск действует до 17:00. Иди через КПП №3, там ждёт машина».\n\nМастер смотрит вам в глаза. «Игорь... будь осторожен. Там не любят посторонних».\n\nВпервые он назвал вас по имени.`,
                choices: [
                    { text: "Взять папку и идти", nextStep: 2, karma: +5, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 2,
                text: `КПП №3 — уже знакомый солдат с первой главы. «А, Семёнов. В часть? Садитесь» — он указывает на «уазик» с затемнёнными стёклами.\n\nВодитель — угрюмый сержант. Едем молча. Дорога идёт через лес, потом мимо полигона (видите мишени — макеты танков).\n\n«ОКО-12» появляется внезапно: гигантские антенны, похожие на скелеты доисторических животных. Радиолокационный комплекс.`,
                choices: [
                    { text: "«Что отслеживает комплекс?»", nextStep: 3, karma: -5, effect: () => { gameState.totalChoices++; } },
                    { text: "Молчать, смотреть в окно", nextStep: 4, karma: +5, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 3,
                text: `«Грибы и ягоды» — хрипло отвечает сержант. «Больше вопросов не будет?»\n\nМашина останавливается у КПП части. Солдаты с автоматами.`,
                choices: [
                    { text: "Выйти из машины", nextStep: 5, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 4,
                text: `Вы молчите. Сержант одобрительно хмыкает. «Умный. Таких долго живут».\n\nПрибываем в часть. Высокий забор, вышки, ангары. Воздух пахнет озоном и машинным маслом.`,
                choices: [
                    { text: "Выйти из машины", nextStep: 5, karma: +5, effect: () => { gameState.totalChoices++; gameState.karma += 5; } }
                ]
            },
            {
                id: 5,
                text: `«Документы и пропуск» — требует офицер. Он проверяет папку, звонит куда-то. «Майор Орлов ждёт. Вон в то здание».\n\nШтаб части — трёхэтажное бетонное здание без окон на первом этаже. Внутри — длинные коридоры, зелёные стены, звонки телефонов.\n\nВас провожают в кабинет 214. Майор Орлов — мужчина лет 45, с умными, усталыми глазами. «Семёнов? Садитесь».\n\nОн берёт папку, не глядя кладёт в сейф. «Спасибо. Можете идти».\n\nНо что-то в его тоне говорит: он ждал вас.`,
                choices: [
                    { text: "«Всё? Я свободен?»", nextStep: 6, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "«А что в папке?»", nextStep: 7, karma: -10, effect: () => { gameState.totalChoices++; } },
                    { text: "«Товарищ майор, я сын Николая Семёнова»", nextStep: 8, karma: -5, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 6,
                text: `«Да, свободны. Машина ждёт у выхода» — говорит Орлов. Но когда вы уже у двери, он добавляет: «Игорь Николаевич... передайте привет отцу. Скажите, что Орлов помнит».\n\nВы оборачиваетесь. Он смотрит на вас с странным выражением — то ли жалость, то ли предупреждение.`,
                choices: [
                    { text: "«Он умер три года назад»", nextStep: 9, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Кивать и выйти", nextStep: 10, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 7,
                text: `Орлов медленно поднимает глаза. «Папка? А, да... чертежи улучшенной антенны. Для телевизоров».\n\nОн улыбается. Слишком неестественно. «Всё. До свидания».\n\nЭто явный намёк, что разговор окончен.`,
                choices: [
                    { text: "Выйти", nextStep: 10, karma: -10, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 8,
                text: `Орлов замирает. «Я знаю» — тихо говорит он. «Я служил с твоим отцом. Он был хорошим солдатом. И хорошим человеком».\n\nОн встаёт, подходит к окну (которое, как вы замечаете, не настоящее — нарисованная панорама леса).\n\n«Он пытался остановить это. И проиграл. Не повторяй его ошибку».\n\n«Это» — что? Но спрашивать вы не решаетесь.`,
                choices: [
                    { text: "«Что он пытался остановить?»", nextStep: 11, karma: -15, effect: () => { gameState.totalChoices++; } },
                    { text: "Молчать, ждать продолжения", nextStep: 12, karma: +5, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 9,
                text: `Лицо Орлова темнеет. «Жаль... Тогда слушай внимательно. Твой отец погиб не от болезни. Его... ликвидировали. Потому что он узнал про «Объект 17»».\n\nОрлов оглядывается, понижает голос до шёпота. «Сегодня вечером, в 22:00, будь у трансформаторной подстанции за штабом. Один. Если хочешь узнать правду — приходи. Если нет... забудь этот разговор».\n\nОн поворачивается спиной — разговор окончен.`,
                choices: [
                    { text: "Выйти из кабинета", nextStep: 10, karma: 0, effect: () => { gameState.totalChoices++; gameState.flags.knowsSecret = true; } }
                ]
            },
            {
                id: 10,
                text: `Вы выходите из штаба. Сержант ждёт в машине. «Обратно?»\n\nКиваете. По дороге назад замечаете нечто странное: у ангара №7 стоят те же грузовики, что вы видели на заводе в среду. Солдаты разгружают ящики с маркировкой «Осторожно! Радиация!»\n\nНо зачем на радиолокационном комплексе радиоактивные материалы?`,
                choices: [
                    { text: "Спросить сержанта", nextStep: 13, karma: -10, effect: () => { gameState.totalChoices++; } },
                    { text: "Промолчать", nextStep: 14, karma: +5, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 11,
                text: `«Не сейчас. Не здесь» — резко говорит Орлов. «Выйди. И забудь, что был у меня».\n\nОн открывает дверь, давая понять, что аудиенция окончена.`,
                choices: [
                    { text: "Выйти", nextStep: 10, karma: -15, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 12,
                text: `Орлов смотрит на вас оценивающе. «Хорошо. Ты умеешь ждать. Это ценное качество».\n\nОн пишет что-то на клочке бумаги, протягивает вам. «Адрес. Приходи сегодня в 20:00. Один. Скажешь, что от Орлова. Поймёшь всё».\n\nНа бумаге: «Ул. Лесная, 7, кв. 12. Кротов».\n\nВаш старик из автобуса!`,
                choices: [
                    { text: "Взять бумагу", nextStep: 15, karma: +10, effect: () => { gameState.totalChoices++; gameState.keyItems.push('address'); } },
                    { text: "Отказаться", nextStep: 16, karma: -10, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 13,
                text: `«Ты что, слепой?» — рычит сержант. «Это дозиметры для проверки фона! Теперь заткнись до конца поездки».\n\nОн явно врёт. Но спорить бесполезно.`,
                choices: [
                    { text: "Замолчать", nextStep: 14, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 14,
                text: `Вы возвращаетесь на завод. Сдаёте пропуск. «Всё нормально?» — спрашивает мастер.\n\n«Да» — отвечаете вы. Но в голове крутятся вопросы: Орлов, «Объект 17», ящики с радиацией...\n\nВечер. Вы в общежитии. Решаете, что делать дальше.`,
                choices: [
                    { text: "Пойти на встречу с Орловым (22:00)", nextStep: 17, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Найти Кротова (ул. Лесная, 7)", nextStep: 18, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Никуда не ходить, забыть всё", nextStep: 19, karma: +20, effect: () => { gameState.totalChoices++; gameState.karma += 20; } }
                ]
            },
            {
                id: 15,
                text: `Вы прячете бумагу. Орлов кивает. «Теперь иди. И будь осторожен. За тобой могут следить».\n\nВозвращаетесь на завод. Вечером решаете посетить Кротова.`,
                choices: [
                    { text: "Отправиться к Кротову", nextStep: 18, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 16,
                text: `«Твой выбор» — пожимает плечами Орлов. «Выйди».\n\nВы возвращаетесь на завод. Мастер смотрит на вас с облегчением. «Жив? Хорошо».\n\nМожет, он прав? Может, не стоит лезть?`,
                choices: [
                    { text: "Решить забыть всё", nextStep: 19, karma: +10, effect: () => { gameState.totalChoices++; gameState.karma += 10; } }
                ]
            },
            {
                id: 17,
                text: `22:00. Трансформаторная подстанция за штабом. Темно, только мигает красная лампочка на столбе.\n\nОрлов уже там. «Ты пришёл. Хорошо».\n\nОн ведёт вас к небольшому люку в земле. «Спускайся. Покажу, за что погиб твой отец».\n\nЛюк ведёт в подземный тоннель.`,
                choices: [
                    { text: "Спуститься", nextStep: 20, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Отказаться", nextStep: 21, karma: -10, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 18,
                text: `УЛ. ЛЕСНАЯ, 7. Старый двухэтажный дом, таких в Атом-5 немного. Квартира 12 на первом этаже.\n\nСтучите. Дверь открывает Кротов. «А, Семёнов. Ждал тебя».\n\nВнутри — квартира, заваленная книгами, чертежами, приборами. На стене — карта Атом-5 с пометками.\n\n«Садись. Расскажу всё, что знаю» — говорит Кротов.`,
                choices: [
                    { text: "Слушать", nextStep: 22, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 19,
                text: `Вы решаете не рисковать. Работаете, живёте тихо. Через неделю вас переводят в цех №2 (повышение!). Зарплата растёт.\n\nНо по ночам снится отец. И его слова: «Городищево — наш дом. И наша тюрьма».\n\nМожет, когда-нибудь вы узнаете правду. Но не сегодня.\n\nГЛАВА ЗАВЕРШЕНА (нейтральный исход).`,
                choices: [
                    { text: "ПРОДОЛЖИТЬ", nextStep: -1, karma: 0, effect: () => { endChapter(); } }
                ]
            },
            {
                id: 20,
                text: `ТОННЕЛЬ. Ведёт под землёй. Стены из бетона, трубы, кабели. Идёте минут десять.\n\n«Мы под полигоном» — объясняет Орлов. «Здесь хранят «Объект 17»».\n\nВпереди — герметичная дверь с кодовым замком. Орлов вводит код. Дверь открывается с шипением.\n\nВнутри — помещение, похожее на лабораторию. В центре — цилиндрическая камера из свинца и стекла. Внутри что-то светится голубоватым светом.\n\n«Это не оружие» — говорит Орлов. «Это... источник энергии. Но не такой, как в реакторе. Он... другой».\n\nВы подходите ближе. В камере — кристалл, испускающий странное свечение.`,
                choices: [
                    { text: "«Что это?»", nextStep: 23, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Прикоснуться к стеклу", nextStep: 24, karma: -20, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 21,
                text: `«Трусишь? Как твой отец в последний момент» — усмехается Орлов. «Ладно. Иди. Но помни: теперь ты знаешь слишком много. Будем следить».\n\nВы возвращаетесь в общежитие. С этого дня за вами следят.\n\nГЛАВА ЗАВЕРШЕНА (осторожный исход).`,
                choices: [
                    { text: "ПРОДОЛЖИТЬ", nextStep: -1, karma: -10, effect: () => { endChapter(); } }
                ]
            },
            {
                id: 22,
                text: `КРОТОВ РАССКАЗЫВАЕТ:\n«В 1974 году при бурении под полигоном нашли... артефакт. Не наш, понимаешь? Не земной. Он излучает энергию, но не радиацию в привычном смысле. Его изучали, назвали «Объект 17».\n\nТвой отец был в группе охраны. Он увидел, как объект... влияет на людей. Одного учёного он... изменил. Не буду подробно. Отец потребовал прекратить эксперименты. Его уволили.\n\nА теперь объект используют. Подключают к «ОКО-12». Антенны работают не на обычных частотах... они что-то... вызывают. Или привлекают. Я не знаю».\n\nКротов показывает графики. «Каждую среду они проводят испытания. Завтра среда. Они попробуют увеличить мощность. Может случиться... непоправимое».\n\nОн смотрит на вас. «Ты должен их остановить. Как твой отец пытался».\n\nВнезапно в окне вспыхивает свет фар. «Они здесь!» — шепчет Кротов.`,
                choices: [
                    { text: "Спрятаться", nextStep: 25, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Встретить их", nextStep: 26, karma: -10, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 23,
                text: `«Мы называем его «Источник» — говорит Орлов. «Он даёт энергию для «ОКО-12». Без него антенны — просто железо. С ним... они видят то, что не должны».\n\nОн включает монитор. На экране — странные сигналы. «Это не спутники, не самолёты. Это... что-то ещё. За пределами атмосферы. И оно отвечает».\n\nОрлов смотрит на вас. «Твой отец считал, что мы играем с огнём. Он был прав. Завтра испытания на полигоне. Если мощность будет слишком высокой... может произойти разрыв».\n\n«Разрыв чего?» — спрашиваете вы.\n\n«Реальности» — тихо отвечает Орлов.`,
                choices: [
                    { text: "«Надо остановить испытания!»", nextStep: 27, karma: +10, effect: () => { gameState.totalChoices++; } },
                    { text: "«Это не моё дело»", nextStep: 28, karma: -10, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 24,
                text: `Вы прикасаетесь к стеклу. Внутри кристалл вспыхивает ярче. По руке проходит странное тепло — не жар, а что-то иное.\n\nГолос в голове. Не звук, а... мысль. «СВОБОДА».\n\nВы отскакиваете. Орлов хватает вас. «Что ты наделал?!»\n\nСирены. Красный свет. «Быстро отсюда!»\n\nВас выводят из тоннеля. «Завтра будут вопросы» — говорит Орлов. «Готовься».\n\nВы возвращаетесь в общежитие. Рука, которой касались стекла, слегка светится в темноте.\n\nГЛАВА ЗАВЕРШЕНА (контакт).`,
                choices: [
                    { text: "ПРОДОЛЖИТЬ", nextStep: -1, karma: -30, effect: () => { endChapter(); gameState.keyItems.push('mark'); } }
                ]
            },
            {
                id: 25,
                text: `Вы прячетесь в чулане. Слышите, как ломают дверь. Голоса: «Кротов! Где ты, старый дурак?»\n\n«Я здесь!» — кричит Кротов. «Оставьте парня, он ничего не знает!»\n\nВыстрел. Тишина.\n\nЧерез минуту уходят. Вы вылезаете. Кротов лежит на полу, ранен в плечо. «Быстрее... возьми» — он суёт вам папку. «Доказательства... останови их...»\n\nОн теряет сознание. Вы берёте папку, убегаете через чёрный ход.\n\nТеперь у вас есть доказательства. И смертельный враг.`,
                choices: [
                    { text: "Спрятать папку и бежать", nextStep: 29, karma: -20, effect: () => { gameState.totalChoices++; gameState.inventory.documents = true; gameState.documents += 3; } }
                ]
            },
            {
                id: 26,
                text: `Вы выходите в коридор. Трое мужчин в штатском. «А, Семёнов. И Кротов. Прекрасно, два зайца».\n\n«Я ничего не сделал!» — кричите вы.\n\n«Молчать!» — бьют по лицу. Надевают наручники.\n\n«В изолятор. Завтра разберёмся».\n\nВас увозят. ГЛАВА ЗАВЕРШЕНА (арест).`,
                choices: [
                    { text: "...", nextStep: -2, karma: -50, effect: () => { endChapter(); gameState.karma = 0; } }
                ]
            },
            {
                id: 27,
                text: `«Остановить?» — смеётся Орлов. «Ты думаешь, я не пытался? Над нами — генералы, Москва, политбюро! Они хотят оружие, которое изменит баланс сил!»\n\nОрлов садится, опускает голову. «Но ты прав. Завтра может быть поздно. Есть план... но он опасен».\n\n«Какой план?»\n\n«Диверсия. Вывести из строя питание «ОКО-12» во время испытаний. Но если поймают... расстрел».\n\nОн смотрит на вас. «Ты поможешь?»`,
                choices: [
                    { text: "«Я помогу»", nextStep: 30, karma: +20, effect: () => { gameState.totalChoices++; gameState.flags.trusted = true; } },
                    { text: "«Я не могу»", nextStep: 31, karma: -10, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 28,
                text: `«Умное решение» — кивает Орлов. «Живи тихо. Забудь, что видел».\n\nОн провожает вас обратно. Вы возвращаетесь в общежитие.\n\nЗавтра среда. Испытания. Вы будете просто наблюдать.\n\nГЛАВА ЗАВЕРШЕНА (бездействие).`,
                choices: [
                    { text: "ПРОДОЛЖИТЬ", nextStep: -1, karma: -20, effect: () => { endChapter(); } }
                ]
            },
            {
                id: 29,
                text: `Вы бежите через спящий город. Папка Кротова в руках жжёт, как уголь. В ней — документы, фотографии, расчёты.\n\n«Объект 17» действительно не земного происхождения. Его нашли в метеорите в 1974-м. Он излучает неизвестный тип энергии, влияет на пространство.\n\nИспытания завтра. Если мощность превысит критический уровень, может произойти «разрыв» — что-то вроде локального коллапса реальности.\n\nВы приходите в общежитие. Ночь. Завтра решающий день.\n\nНужно решить: использовать документы, чтобы предупредить Москву? Или действовать самостоятельно?`,
                choices: [
                    { text: "Попытаться связаться с Москвой", nextStep: 32, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Помочь Орлову с диверсией", nextStep: 33, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Уничтожить документы, забыть всё", nextStep: 34, karma: -30, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 30,
                text: `«Хорошо» — Орлов протягивает руку. «Завтра в 13:00 у трансформаторной подстанции. Принеси инструмент из завода — кусачки для высоковольтных кабелей».\n\n«Как я вынесу их с завода?»\n\n«Мастер Петров поможет. Он... наш».\n\nВы возвращаетесь в общежитие. Ночь тревожная.\n\nЗавтра — диверсия. Или смерть.\n\nГЛАВА ЗАВЕРШЕНА (путь сопротивления).`,
                choices: [
                    { text: "ПРОДОЛЖИТЬ", nextStep: -1, karma: +20, effect: () => { endChapter(); gameState.keyItems.push('wire_cutters'); } }
                ]
            },
            {
                id: 31,
                text: `«Жаль» — вздыхает Орлов. «Тогда прощай. И удачи».\n\nОн уходит в тоннель. Вы возвращаетесь один.\n\nЗавтра испытания. Вы будете просто наблюдать. И надеяться, что ничего страшного не случится.\n\nГЛАВА ЗАВЕРШЕНА (пассивность).`,
                choices: [
                    { text: "ПРОДОЛЖИТЬ", nextStep: -1, karma: -15, effect: () => { endChapter(); } }
                ]
            },
            {
                id: 32,
                text: `Утром идёте на почту. Хотите отправить документы в Москву, в КГБ, на имя председателя Андропова.\n\nНо почтовый работник смотрит на вас странно. «Документы с грифом? Нужна специальная связь. Идите в штаб части».\n\nЭто ловушка? Или реальный шанс?\n\nВы колеблетесь.`,
                choices: [
                    { text: "Пойти в штаб", nextStep: 35, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Вернуться, передумать", nextStep: 33, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 33,
                text: `Вы решаете действовать. Идёте на завод, находите мастера Петрова.\n\n«Кусачки? Для Орлова?» — он кивает. «Вечером заберёшь из моего шкафа».\n\n«Вы... знали?»\n\n«Сынок, я здесь с 1958 года. Я всё знаю».\n\nОн кладёт руку вам на плечо. «Твой отец был храбрым. Будь достоин его».\n\nВечером вы получаете инструмент. Завтра в 13:00 — встреча с Орловым.\n\nГЛАВА ЗАВЕРШЕНА (подготовка к диверсии).`,
                choices: [
                    { text: "ПРОДОЛЖИТЬ", nextStep: -1, karma: +10, effect: () => { endChapter(); gameState.keyItems.push('wire_cutters'); gameState.flags.trusted = true; } }
                ]
            },
            {
                id: 34,
                text: `Вы сжигаете документы в печке общежития. Дым чёрный, пахнет химией.\n\n«Всё кончено» — думаете вы. «Я просто буду работать. Жить».\n\nНо когда ложитесь спать, снится отец. Он молчит, но в его глазах — разочарование.\n\nЗавтра испытания. Вы будете работать в цеху, как ни в чём не бывало.\n\nГЛАВА ЗАВЕРШЕНА (отступничество).`,
                choices: [
                    { text: "ПРОДОЛЖИТЬ", nextStep: -1, karma: -40, effect: () => { endChapter(); gameState.karma -= 20; } }
                ]
            },
            {
                id: 35,
                text: `Вы идёте в штаб части. Просите срочную связь с Москвой.\n\nВас проводят к полковнику. «Документы? Покажите».\n\nВы отдаёте папку Кротова. Полковник листает, его лицо становится всё мрачнее.\n\n«Это... серьёзно. Очень серьёзно».\n\nОн звонит куда-то. «Да, товарищ генерал. У меня тут молодой инженер с документами... Да, понял».\n\nВешает трубку. «Товарищ Семёнов, вы арестованы за шпионаж и клевету на советскую науку».\n\nЛовушка! Вас хватают.\n\n«Завтра расстрел» — говорит полковник.\n\nКонец.`,
                choices: [
                    { text: "...", nextStep: -3, karma: -100, effect: () => { endChapter(); } }
                ]
            }
        ]
    },

    // ========== ГЛАВА 4: ИНЦИДЕНТ НА ПОЛИГОНЕ ==========
    {
        id: 3,
        title: "Инцидент на полигоне",
        location: "Испытательный полигон, северный сектор",
        datetime: "23 АПРЕЛЯ 1981, 14:30",
        steps: [
            {
                id: 0,
                text: `СРЕДА. ДЕНЬ ИСПЫТАНИЙ.\n\nУтро начинается странно: над городом висит неестественно жёлтое небо. Птицы молчат.\n\nНа заводе — напряжение. Все говорят шёпотом. Мастер Петров передаёт вам записку: «13:00, трансформаторная. Не опоздай».\n\nВ 12:30 вы «отпрашиваетесь по болезни». Уходите с завода.\n\nТрансформаторная подстанция за штабом. Орлов уже там. «Инструмент есть?»\n\nВы показываете кусачки. «Хорошо. План простой: в 14:30, когда начнутся испытания, я отвлеку охрану. Ты перережешь кабель питания антенн. Главное — не силовой, а управляющий. Он красный».\n\n«А что будет после?»\n\n«Беги в лес. Я найду тебя после».\n\nВы прячетесь в кустах. Ждёте.`,
                choices: [
                    { text: "Ждать сигнала", nextStep: 1, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Передумать, уйти", nextStep: 2, karma: -20, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 1,
                text: `14:25. К полигону подъезжают грузовики. Солдаты разгружают оборудование. Видите знакомого капитана из особого отдела.\n\n14:28. Раздаётся гудок. Испытания начинаются.\n\nАнтенны «ОКО-12» медленно поворачиваются, нацеливаются в небо. Гудение нарастает.\n\n14:29. Орлов даёт сигнал — два мигания фонариком.\n\nВаша очередь.`,
                choices: [
                    { text: "Подойти к кабелям", nextStep: 3, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Заморозить от страха", nextStep: 4, karma: -10, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 2,
                text: `Вы уходите. Возвращаетесь в общежитие, ложитесь в постель, делаете вид, что болеете.\n\nЧерез час слышите странный гул. Стекла в окнах дребезжат.\n\nВыглядываете. Над полигоном — фиолетовое свечение. Потом взрыв.\n\nСирены. Крики.\n\nВы понимаете: что-то пошло не так. И вы могли это предотвратить.\n\nГЛАВА ЗАВЕРШЕНА (трусость).`,
                choices: [
                    { text: "ПРОДОЛЖИТЬ", nextStep: -1, karma: -50, effect: () => { endChapter(); gameState.karma -= 30; } }
                ]
            },
            {
                id: 3,
                text: `Вы подползаете к щиту с кабелями. Красный кабель — вот он! Берёте кусачки...\n\nИ тут сзади: «Стоять! Руки вверх!»\n\nОхранник. Он вас заметил.`,
                choices: [
                    { text: "Бросить кусачки, сдаться", nextStep: 5, karma: -20, effect: () => { gameState.totalChoices++; } },
                    { text: "Попытаться убежать", nextStep: 6, karma: -10, effect: () => { gameState.totalChoices++; } },
                    { text: "Перерезать кабель, несмотря ни на что", nextStep: 7, karma: +30, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 4,
                text: `Вы не можете пошевелиться. Страх парализует.\n\nАнтенны гудят всё громче. Воздух трепещет.\n\nИ вдруг... тишина. Потом хлопок. И фиолетовая вспышка над полигоном.\n\nЧто-то пошло не так. Без вашего вмешательства.\n\nСирены. Бегут люди.\n\nВы остаётесь в кустах, дрожа.`,
                choices: [
                    { text: "Выбежать, посмотреть что случилось", nextStep: 8, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Бежать прочь", nextStep: 9, karma: -10, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 5,
                text: `Вы поднимаете руки. Охранник подходит. «А, Семёнов. Я так и думал».\n\nЭто сержант, который возил вас в часть. «Орлов тебя подставил, парень. Он уже в камере».\n\nВас ведут в штаб. По дороге видите: антенны работают на полную мощность. Небо темнеет.\n\n«Что они делают?» — спрашиваете вы.\n\n«Открывают дверь» — мрачно отвечает сержант. «И, кажется, дверь открывается».\n\nВнезапно земля содрогается.`,
                choices: [
                    { text: "Упасть на землю", nextStep: 10, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 6,
                text: `Вы бросаетесь бежать. Охранник стреляет в воздух. «Стой!»\n\nВы бежите к лесу. Пули щёлкают по веткам.\n\nДобегаете до опушки. Оборачиваетесь: над полигоном образуется... что-то вроде воронки из света. Воздух искрится.\n\n«Боже...» — шепчете вы.\n\nИ тут воронка взрывается. Ударная волна сбивает вас с ног.`,
                choices: [
                    { text: "Прийти в себя", nextStep: 11, karma: -10, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 7,
                text: `Вы перерезаете красный кабель. Искры, дым.\n\nАнтенны замирают. Гудение сменяется треском, потом — тишиной.\n\n«Ты что наделал?!» — кричит охранник.\n\nНо уже поздно. Из динамиков: «Авария! Прекратите испытания!»\n\nВы сделали это. Остановили.\n\nНо вдруг... тишина становится слишком глубокой. И из центра полигона вырывается столб фиолетового света.`,
                choices: [
                    { text: "Смотреть", nextStep: 12, karma: +20, effect: () => { gameState.totalChoices++; gameState.karma += 20; } },
                    { text: "Бежать", nextStep: 13, karma: +10, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 8,
                text: `Вы выбегаете из кустов. Картина апокалипсиса: в центре полигона — воронка диаметром метров тридцать. Из неё бьёт фиолетовое свечение. Воздух дрожит.\n\nЛюди бегут в панике. Кто-то лежит на земле, не двигаясь.\n\nВидите Орлова — его ведут двое солдат. Он кричит вам: «Беги, Игорь! Они всё скроют!»\n\nКапитан особого отдела замечает вас. «Взять его!»\n\nПора бежать.`,
                choices: [
                    { text: "Бежать к лесу", nextStep: 9, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Подойти к воронке", nextStep: 14, karma: -20, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 9,
                text: `Вы бежите в лес. За спиной — крики, сирены, странные звуки.\n\nДобегаете до старого бункера времён войны. Прячетесь внутри.\n\nЧерез час стихает. Вы выглядываете: над полигоном висит странное облако. Фиолетовое, мерцающее.\n\nГород Атом-5 больше не будет прежним.\n\nВы остаётесь в живых. Но что теперь?`,
                choices: [
                    { text: "Вернуться в город", nextStep: 15, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Идти в сторону шоссе, попытаться уехать", nextStep: 16, karma: -10, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 10,
                text: `Земля трясётся. Слышен рёв, будто сама реальность рвётся.\n\nВы поднимаете глаза: над полигоном открывается... окно. Сквозь него видно что-то неземное: странные структуры, светящиеся формы.\n\n«Закройте! Закройте!» — кричит кто-то.\n\nНо поздно. Из окна вырывается луч света. Он попадает в антенну — та плавится, как пластилин.\n\nОхранник тащит вас в бункер. «Сиди здесь!»\n\nДверь захлопывается. Темно.`,
                choices: [
                    { text: "Ждать", nextStep: 17, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 11,
                text: `Вы приходите в себя. Лес вокруг... изменён. Деревья искривлены, листья фиолетовые. Воздух пахнет озоном и чем-то ещё — сладковатым, неприятным.\n\nСлышите стоны. Неподалёку лежит солдат. Его форма... будто постарела на десятки лет за секунды.\n\n«Что... что было?» — шепчет он.\n\nВы не знаете. Но понимаете: произошло нечто ужасное.\n\nНужно найти уцелевших. Или бежать.`,
                choices: [
                    { text: "Помочь солдату", nextStep: 18, karma: +10, effect: () => { gameState.totalChoices++; } },
                    { text: "Идти к городу", nextStep: 19, karma: 0, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 12,
                text: `Вы смотрите. Столб света расширяется, формируя шар. Внутри шара... движение. Тени.\n\n«Объект 17 активировался!» — кричит учёный в белом халате. «Он создал портал!»\n\nПортал? В другое место? Или в другое... измерение?\n\nИз шара выходит... нечто. Похоже на человека, но не совсем. Слишком плавные движения, слишком бледная кожа.\n\nОно смотрит на вас. Глаза без зрачков, светящиеся.\n\n«ПРИВЕТСТВИЕ» — говорит голос в голове. Не звук. Прямо в сознании.`,
                choices: [
                    { text: "Ответить", nextStep: 20, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Бежать", nextStep: 13, karma: -10, effect: () => { gameState.totalChoices++; } }
                ]
            },
            {
                id: 13,
                text: `Вы бежите. За спиной — взрыв. Свет.\n\nПадаете, теряете сознание.\n\nОчнулись в медсанчасти. Рядом — капитан особого отдела. «Жив? Хорошо. Тебя ждёт допрос».\n\n«Что случилось?»\n\n«Несчастный случай на полигоне. Взрыв баллона с кислородом. Погибло трое. Ты видел?»\n\nЭто ложь. Вы знаете. Но спорить бесполезно.\n\n«Я... ничего не видел».\n\n«Умный мальчик» — улыбается капитан. «Так и запротоколируем».\n\nНо в его глазах — угроза. Вы в ловушке.\n\nГЛАВА ЗАВЕРШЕНА (официальная версия).`,
                choices: [
                    { text: "ПРОДОЛЖИТЬ", nextStep: -1, karma: -40, effect: () => { endChapter(); } }
                ]
            },
            {
                id: 14,
                text: `Вы подходите к воронке. Край — оплавленный, стекловидный. Внутри — глубина, свет.\n\nИ вдруг из глубины поднимается... фигура. Человек? Нет, не совсем. Черты лица размыты, кожа полупрозрачная.\n\nОн смотрит на вас. Протягивает руку.\n\nВаша собственная рука тянется навстречу...\n\nПрикосновение. Холод. И поток образов: другие миры, другие времена, бесконечность...\n\nВы отдергиваете руку. Фигура растворяется в свете.\n\nВы падаете на колени. Теперь вы знаете. Слишком много знаете.\n\nГЛАВА ЗАВЕРШЕНА (контакт).`,
                choices: [
                    { text: "ПРОДОЛЖИТЬ", nextStep: -1, karma: 0, effect: () => { endChapter(); gameState.flags.knowsSecret = true; gameState.keyItems.push('vision'); } }
                ]
            },
            // ... (продолжение главы 4, шаги 15-30)
            {
                id: 30,
                text: `Внезапно всё прекращается. Свет гаснет. Тишина.\n\nВы лежите на земле, смотрите в небо. Оно снова синее. Облако рассеивается.\n\n«Конец?» — думаете вы.\n\nНо нет. Из рупора на вышке: «Внимание! Радиационная опасность! Все гражданам оставаться в помещениях!»\n\nЭто прикрытие. Они объяснят всё радиацией.\n\nВы встаёте. Город Атом-5 теперь — зона отчуждения. И вы внутри.\n\nНужно решить: бежать? Или остаться и бороться за правду?\n\nГЛАВА ЗАВЕРШЕНА.`,
                choices: [
                    { text: "ЗАВЕРШИТЬ ГЛАВУ", nextStep: -1, karma: 0, effect: () => { endChapter(); } }
                ]
            }
        ]
    },

    // ========== ГЛАВА 5: РЕШЕНИЕ ==========
    {
        id: 4,
        title: "Решение",
        location: "Атом-5, различные локации",
        datetime: "24-30 АПРЕЛЯ 1981",
        steps: [
            {
                id: 0,
                text: `НЕДЕЛЯ ПОСЛЕ ИНЦИДЕНТА. Город на осадном положении. Въезд и выезд запрещены. По радио — версия о «взрыве баллона с кислородом». Погибшими объявлены 4 человека (на самом деле больше).\n\nНо вы знаете правду. И теперь у вас выбор.\n\nУтром к вам в общежитие приходит мастер Петров. «Игорь... Орлов в камере. Его обвиняют в саботаже. Кротов в больнице, без сознания. Ты следующий».\n\n«Что мне делать?»\n\n«У тебя три варианта» — говорит Петров. «Первый: бежать. Есть старый тоннель к реке. Второй: остаться, молчать, стать своим. Третий...» он понижает голос. «Третий: собрать доказательства и передать в Москву, минуя местных. Но это смертельно опасно».\n\nОн даёт вам ключ. «От склада №7. Там кое-что, что поможет».\n\nУходит. Вы остаётесь с выбором.`,
                choices: [
                    { text: "Бежать через тоннель", nextStep: 1, karma: -10, effect: () => { gameState.totalChoices++; } },
                    { text: "Остаться, стать «своим»", nextStep: 2, karma: -30, effect: () => { gameState.totalChoices++; } },
                    { text: "Бороться, собрать доказательства", nextStep: 3, karma: +20, effect: () => { gameState.totalChoices++; } }
                ]
            },
            // ... (шаги 1-20 для разных концовок)
            {
                id: 20,
                text: `ФИНАЛЬНОЕ РЕШЕНИЕ. У вас есть всё: документы, фотографии, показания. Но кому доверить?\n\nПетров предлагает: «Есть человек в Москве, генерал-лейтенант Соколов. Он честный. Но добраться до него...»\n\nПути:\n1. Через официальные каналы (риск: перехватят)\n2. Лично, самовольно уехав в Москву (риск: поймают)\n3. Через западных журналистов (риск: обвинят в шпионаже)\n4. Спрятать всё и ждать лучших времён\n\nЧто выберете?`,
                choices: [
                    { text: "Официальные каналы", nextStep: 21, karma: 0, effect: () => { gameState.totalChoices++; } },
                    { text: "Лично в Москву", nextStep: 22, karma: +10, effect: () => { gameState.totalChoices++; } },
                    { text: "Западные журналисты", nextStep: 23, karma: -50, effect: () => { gameState.totalChoices++; } },
                    { text: "Спрятать и ждать", nextStep: 24, karma: -20, effect: () => { gameState.totalChoices++; } }
                ]
            },
            // Концовки (21-30)
            {
                id: 21,
                text: `Вы отправляете документы через официальную почту с грифом «Срочно. Председателю КГБ».\n\nЧерез неделю приезжает комиссия из Москвы. Расследование. Орлова освобождают. Капитана особого отдела арестовывают.\n\n«Объект 17» запечатывают. Испытания прекращают.\n\nВас вызывают в Москву, награждают орденом «За храбрость»... и предлагают работу в другом закрытом городе. Вы соглашаетесь.\n\nАтом-5 постепенно возвращается к нормальной жизни. Правда стала известна узкому кругу. Вы — герой. Но теперь вы навсегда часть системы.\n\nКОНЦОВКА: «Герой системы»`,
                choices: [
                    { text: "ЗАВЕРШИТЬ ИГРУ", nextStep: -1, karma: +50, effect: () => { endGame('hero'); } }
                ]
            },
            {
                id: 22,
                text: `Вы самовольно садитесь на поезд до Москвы. Рискуете быть арестованным на каждой станции.\n\nНо вам везёт. Вы находите генерала Соколова, передаёте документы.\n\nОн поражён. «Это... чудовищно».\n\nНа следующий день — аресты в Атом-5. Проект «ОКО-12» закрывают.\n\nНо вас... увольняют. Вы нарушили субординацию. Выдаёте премию и просят забыть.\n\nВы возвращаетесь в Москву, к обычной жизни. Но по ночам видите фиолетовый свет и слышите голос: «ПРИВЕТСТВИЕ»...\n\nКОНЦОВКА: «Правдоискатель»`,
                choices: [
                    { text: "ЗАВЕРШИТЬ ИГРУ", nextStep: -1, karma: +30, effect: () => { endGame('truth_seeker'); } }
                ]
            },
            {
                id: 23,
                text: `Вы передаёте копии документов иностранному корреспонденту.\n\nЧерез месяц в западной прессе — сенсация: «Советский город-призрак! Инопланетные эксперименты!»\n\nВ СССР — скандал. Вас арестовывают за шпионаж и измену Родине. Суд. Приговор: 15 лет лагерей.\n\nАтом-5 полностью закрывают, жителей расселяют. Правда похоронена под слоем пропаганды.\n\nВы в лагере. Орлов в соседнем бараке. Он говорит: «Хотели как лучше...»\n\nКОНЦОВКА: «Изменник Родины»`,
                choices: [
                    { text: "ЗАВЕРШИТЬ ИГРУ", nextStep: -1, karma: -100, effect: () => { endGame('traitor'); } }
                ]
            },
            {
                id: 24,
                text: `Вы прячете документы в надёжном месте. Ждёте.\n\nГоды идут. 1985-й, 1991-й... СССР распадается. Архивы открываются.\n\nВы достаёте документы, публикуете. Но теперь всем не до того — страна в кризисе.\n\nВашу историю печатают в жёлтой прессе как «сенсацию». Никто серьёзно не воспринимает.\n\nАтом-5 становится обычным городком, потом — городом-призраком. Вы живёте там до старости, храня тайну.\n\nПеред смертью пишете мемуары. Их находят после вашей смерти...\n\nКОНЦОВКА: «Хранитель тайны»`,
                choices: [
                    { text: "ЗАВЕРШИТЬ ИГРУ", nextStep: -1, karma: 0, effect: () => { endGame('keeper'); } }
                ]
            }
        ]
    }
];

// ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
let currentStepData = null;
let typingInterval = null;
let isTyping = false;

// ========== ЭЛЕМЕНТЫ ДОМ ==========
const elements = {
    // Экраны
    menuScreen: document.getElementById('menu-screen'),
    chapterScreen: document.getElementById('chapter-screen'),
    loreScreen: document.getElementById('lore-screen'),
    gameScreen: document.getElementById('game-screen'),
    chapterEndScreen: document.getElementById('chapter-end-screen'),
    endingScreen: document.getElementById('ending-screen'),
    
    // Игровые элементы
    storyText: document.getElementById('story-text'),
    choicesContainer: document.getElementById('choices-container'),
    chapterTitle: document.getElementById('chapter-title'),
    locationEl: document.getElementById('location'),
    datetimeEl: document.getElementById('datetime'),
    karmaValue: document.getElementById('karma-value'),
    passStatus: document.getElementById('pass-status'),
    docsStatus: document.getElementById('docs-status'),
    keyStatus: document.getElementById('key-status'),
    choiceCount: document.getElementById('choice-count'),
    hintEl: document.getElementById('hint'),
    
    // Экран завершения главы
    chapterEndName: document.getElementById('chapter-end-name'),
    summaryText: document.getElementById('summary-text'),
    statKarma: document.getElementById('stat-karma'),
    statDocs: document.getElementById('stat-docs'),
    statChoices: document.getElementById('stat-choices'),
    achvList: document.getElementById('achv-list'),
    
    // Экран концовки
    endingTitle: document.getElementById('ending-title'),
    endingText: document.getElementById('ending-text'),
    endingStats: document.getElementById('ending-stats')
};

// ========== ОСНОВНЫЕ ФУНКЦИИ ==========

// Показать экран
function showScreen(screenId) {
    // Скрыть все экраны
    Object.values(elements).forEach(el => {
        if (el && el.classList && el.classList.contains('screen')) {
            el.classList.remove('active');
        }
    });
    
    // Показать нужный экран
    const screen = document.getElementById(screenId);
    if (screen) {
        screen.classList.add('active');
    }
}

// Главное меню
function showMenu() {
    showScreen('menu-screen');
    updateStatsDisplay();
}

function showChapterSelect() {
    showScreen('chapter-screen');
}

function showLore() {
    showScreen('lore-screen');
}

// Начать игру
function startGame() {
    // Сброс состояния (кроме статистики)
    gameState.currentChapter = 0;
    gameState.currentStep = 0;
    gameState.totalChoices = 0;
    gameState.karma = 50;
    gameState.documents = 0;
    gameState.keyItems = [];
    gameState.endingsUnlocked = [];
    gameState.flags = {
        metOldMan: false,
        knowsAboutTunnel: false,
        warnedAboutAccident: false,
        suspicious: false,
        trusted: false,
        knowsSecret: false
    };
    gameState.inventory = {
        pass: true,
        notebook: false,
        keyCard: false,
        dosimeter: false,
        photo: false
    };
    
    loadChapter(0);
}

// Загрузить главу
function loadChapter(chapterIndex) {
    if (chapterIndex >= chapters.length) {
        endGame('complete');
        return;
    }
    
    gameState.currentChapter = chapterIndex;
    gameState.currentStep = 0;
    showScreen('game-screen');
    updateGameUI();
    playStep();
}

// Обновить игровой интерфейс
function updateGameUI() {
    const chapter = chapters[gameState.currentChapter];
    
    // Заголовки
    if (elements.chapterTitle) elements.chapterTitle.textContent = chapter.title;
    if (elements.locationEl) elements.locationEl.textContent = chapter.location;
    if (elements.datetimeEl) elements.datetimeEl.textContent = chapter.datetime;
    
    // Статистика
    if (elements.karmaValue) elements.karmaValue.textContent = gameState.karma;
    if (elements.passStatus) elements.passStatus.textContent = gameState.inventory.pass ? "ДЕЙСТВ." : "НЕТ";
    if (elements.docsStatus) elements.docsStatus.textContent = gameState.inventory.notebook ? "ЕСТЬ" : "НЕТ";
    if (elements.keyStatus) elements.keyStatus.textContent = gameState.keyItems.length > 0 ? "ЕСТЬ" : "НЕТ";
    if (elements.choiceCount) elements.choiceCount.textContent = gameState.totalChoices;
    
    // Цвет кармы
    if (elements.karmaValue) {
        if (gameState.karma >= 70) elements.karmaValue.style.color = "#66ff99";
        else if (gameState.karma >= 40) elements.karmaValue.style.color = "#ffcc66";
        else elements.karmaValue.style.color = "#ff6666";
    }
}

// Новая версия playStep() с поддержкой задержек и изображений
async function playStep() {
    const chapter = chapters[gameState.currentChapter];
    if (!chapter || !chapter.steps || gameState.currentStep >= chapter.steps.length) {
        endChapter();
        return;
    }
    
    currentStepData = chapter.steps[gameState.currentStep];
    
    // Очистить контейнер выбора
    if (elements.choicesContainer) elements.choicesContainer.innerHTML = "";
    if (elements.hintEl) elements.hintEl.textContent = "Идёт загрузка текста...";
    
    // Разбиваем текст на части по командам
    const text = currentStepData.text;
    const parts = splitTextByCommands(text);
    
    // Напечатать текст с задержками
    await typeTextWithDelays(parts);
    
    // Показать выбор после завершения печати
    showChoices();
}

// Разбивает текст на части с командами
function splitTextByCommands(text) {
    const parts = [];
    let lastIndex = 0;
    
    // Регулярка для команд [[DELAY:X]] и [[IMG:URL]]
    const commandRegex = /\[\[(DELAY:\d+|IMG:[^\]]+)\]\]/g;
    let match;
    
    while ((match = commandRegex.exec(text)) !== null) {
        // Текст до команды
        if (match.index > lastIndex) {
            parts.push({
                type: 'text',
                content: text.substring(lastIndex, match.index)
            });
        }
        
        // Сама команда
        const command = match[1];
        if (command.startsWith('DELAY:')) {
            const delay = parseInt(command.substring(6));
            parts.push({
                type: 'delay',
                duration: delay
            });
        } else if (command.startsWith('IMG:')) {
            const imageUrl = command.substring(4).trim();
            parts.push({
                type: 'image',
                url: imageUrl
            });
        }
        
        lastIndex = match.index + match[0].length;
    }
    
    // Остаток текста после последней команды
    if (lastIndex < text.length) {
        parts.push({
            type: 'text',
            content: text.substring(lastIndex)
        });
    }
    
    return parts;
}

// Печатает текст с задержками и изображениями
async function typeTextWithDelays(parts) {
    if (!elements.storyText) return;
    
    elements.storyText.textContent = "";
    isTyping = true;
    
    for (const part of parts) {
        switch (part.type) {
            case 'text':
                await typeText(part.content);
                break;
                
            case 'delay':
                await wait(part.duration);
                break;
                
            case 'image':
                // Пауза перед изображением
                await wait(500);
                // Показываем изображение и ждем закрытия
                await showImageAndWait(part.url);
                break;
        }
    }
    
    isTyping = false;
}

// Печатает текст посимвольно с движущимся курсором
async function typeText(text) {
    return new Promise(resolve => {
        if (!elements.storyText) return resolve();
        
        let i = 0;
        const cursor = document.createElement('span');
        cursor.id = 'typewriter-cursor';
        cursor.textContent = '|';
        cursor.style.cssText = `
            display: inline;
            animation: blink 1s infinite;
            color: #00e5ff;
            font-weight: bold;
            margin-left: 2px;
        `;
        
        // Добавляем курсор в конец
        elements.storyText.appendChild(cursor);
        
        const typing = setInterval(() => {
            if (i < text.length) {
                // Вставляем символ перед курсором
                const textNode = document.createTextNode(text.charAt(i));
                elements.storyText.insertBefore(textNode, cursor);
                i++;
                
                // Прокручиваем контейнер к курсору
                elements.storyText.parentElement.scrollTop = elements.storyText.parentElement.scrollHeight;
            } else {
                clearInterval(typing);
                // Убираем курсор когда текст напечатан
                cursor.remove();
                resolve();
            }
        }, 30);
    });
}

// Ждет указанное время
async function wait(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Показывает изображение и ждет закрытия
async function showImageAndWait(imageUrl) {
    return new Promise(resolve => {
        // Создаем контейнер
        const imageContainer = document.createElement('div');
        imageContainer.id = 'fullscreen-image';
        imageContainer.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.5s;
        `;
        
        // Изображение
        const img = document.createElement('img');
        img.src = imageUrl;
        img.style.cssText = `
            max-width: 90%;
            max-height: 90%;
            border: 2px solid #00a8ff;
            box-shadow: 0 0 40px rgba(0, 168, 255, 0.7);
            border-radius: 5px;
            object-fit: contain;
        `;
        
        // Кнопка закрытия
        const closeBtn = document.createElement('div');
        closeBtn.textContent = '✕';
        closeBtn.style.cssText = `
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid white;
            transition: all 0.3s;
        `;
        closeBtn.onmouseover = () => {
            closeBtn.style.background = 'rgba(255, 0, 0, 0.7)';
            closeBtn.style.transform = 'scale(1.1)';
        };
        closeBtn.onmouseout = () => {
            closeBtn.style.background = 'rgba(0, 0, 0, 0.5)';
            closeBtn.style.transform = 'scale(1)';
        };
        
        imageContainer.appendChild(img);
        imageContainer.appendChild(closeBtn);
        document.body.appendChild(imageContainer);
        
        // Функция закрытия
        const closeImage = () => {
            imageContainer.style.animation = 'fadeOut 0.5s';
            setTimeout(() => {
                if (imageContainer.parentNode) {
                    imageContainer.parentNode.removeChild(imageContainer);
                }
                resolve(); // Продолжаем выполнение
            }, 500);
        };
        
        // Закрытие по клику на крестик или изображение
        closeBtn.addEventListener('click', closeImage);
        imageContainer.addEventListener('click', (e) => {
            if (e.target === imageContainer) {
                closeImage();
            }
        });
        
        // Закрытие по Escape
        const escapeHandler = (e) => {
            if (e.key === 'Escape') {
                closeImage();
                document.removeEventListener('keydown', escapeHandler);
            }
        };
        document.addEventListener('keydown', escapeHandler);
        
        // Автоматическое закрытие через 10 секунд (на всякий случай)
        setTimeout(() => {
            if (document.getElementById('fullscreen-image')) {
                closeImage();
            }
        }, 10000);
    });
}


// Показать выбор
function showChoices() {
    if (!currentStepData || !elements.choicesContainer) return;
    
    elements.choicesContainer.innerHTML = "";
    
    if (currentStepData.choices && currentStepData.choices.length > 0) {
        if (elements.hintEl) elements.hintEl.textContent = `Выберите действие (вариантов: ${currentStepData.choices.length})`;
        
        currentStepData.choices.forEach(choice => {
            const button = document.createElement('button');
            button.className = 'choice-btn';
            button.textContent = choice.text;
            button.onclick = () => makeChoice(choice);
            elements.choicesContainer.appendChild(button);
        });
    } else {
        const button = document.createElement('button');
        button.className = 'choice-btn';
        button.textContent = "Продолжить...";
        button.onclick = () => {
            gameState.currentStep++;
            playStep();
        };
        elements.choicesContainer.appendChild(button);
    }
}

// Сделать выбор
function makeChoice(choice) {
    if (isTyping) return; // Не позволяем выбирать во время печати
    
    gameState.totalChoices++;
    
    // Применить эффект выбора
    if (choice.effect) choice.effect();
    
    // Обновить карму
    if (choice.karma) {
        gameState.karma += choice.karma;
        gameState.karma = Math.max(0, Math.min(100, gameState.karma));
    }
    
    // Обновить интерфейс
    updateGameUI();
    
    // Перейти к следующему шагу
    if (choice.nextStep === -1) {
        endChapter();
    } else if (choice.nextStep === -2) {
        badEnding("арест");
    } else if (choice.nextStep === -3) {
        badEnding("расстрел");
    } else {
        gameState.currentStep = choice.nextStep;
        playStep();
    }
}

// Завершить главу
function endChapter() {
    // Подвести итоги главы
    if (elements.chapterEndName) {
        elements.chapterEndName.textContent = `Глава ${gameState.currentChapter + 1}: ${chapters[gameState.currentChapter].title}`;
    }
    
    if (elements.summaryText) {
        let summary = "Глава завершена. ";
        if (gameState.karma >= 70) summary += "Вы пользуетесь доверием системы. ";
        else if (gameState.karma >= 40) summary += "Вы вызываете умеренное подозрение. ";
        else summary += "Вы в чёрном списке. ";
        
        if (gameState.documents > 0) summary += `Найдено секретных документов: ${gameState.documents}. `;
        if (gameState.keyItems.length > 0) summary += `Получено ключевых предметов: ${gameState.keyItems.length}.`;
        
        elements.summaryText.textContent = summary;
    }
    
    if (elements.statKarma) elements.statKarma.textContent = gameState.karma;
    if (elements.statDocs) elements.statDocs.textContent = gameState.documents;
    if (elements.statChoices) elements.statChoices.textContent = gameState.totalChoices;
    
    if (elements.achvList) {
        let achievements = [];
        if (gameState.flags.trusted) achievements.push("Доверие системы");
        if (gameState.flags.knowsSecret) achievements.push("Знает тайну");
        if (gameState.inventory.notebook) achievements.push("Блокнот Кротова");
        if (gameState.keyItems.includes('badge')) achievements.push("Значок Атом-5");
        
        elements.achvList.textContent = achievements.length > 0 ? achievements.join(", ") : "Нет достижений";
    }
    
    showScreen('chapter-end-screen');
}

// Продолжить игру
function continueGame() {
    gameState.currentChapter++;
    if (gameState.currentChapter < chapters.length) {
        loadChapter(gameState.currentChapter);
    } else {
        endGame('complete');
    }
}

// Плохая концовка
function badEnding(reason) {
    if (elements.endingTitle) elements.endingTitle.textContent = "КОНЕЦ ИГРЫ";
    if (elements.endingText) {
        let text = "";
        switch(reason) {
            case "арест":
                text = "Вас арестовали. Обвинение: шпионаж и подрыв государственной безопасности.\n\nСуд: 15 лет лагерей строгого режима.\n\nАтом-5 продолжает свою работу. Правда похоронена.\n\nКОНЦОВКА: «Узник»";
                break;
            case "расстрел":
                text = "Расстрел. Без суда, без следствия.\n\nВаше дело засекречено на 75 лет.\n\nАтом-5 стирает все следы вашего существования.\n\nКОНЦОВКА: «Стертый»";
                break;
            default:
                text = "Игра завершена. Неизвестная концовка.";
        }
        elements.endingText.textContent = text;
    }
    
    if (elements.endingStats) {
        elements.endingStats.innerHTML = `
            <p>Итоговая статистика:</p>
            <p>Доверие системы: ${gameState.karma}</p>
            <p>Секретных документов: ${gameState.documents}</p>
            <p>Принято решений: ${gameState.totalChoices}</p>
        `;
    }
    
    showScreen('ending-screen');
}

// Завершить игру (хорошие концовки)
function endGame(endingType) {
    let title = "";
    let text = "";
    
    switch(endingType) {
        case 'hero':
            title = "ГЕРОЙ СИСТЕМЫ";
            text = `Вы раскрыли правду через официальные каналы. Комиссия из Москвы разоблачила преступные эксперименты.\n\nАтом-5 возвращается к нормальной жизни. «Объект 17» запечатан.\n\nВас награждают орденом и переводят на повышение в другой закрытый город.\n\nВы — герой. Но теперь навсегда часть системы, которую когда-то пытались изменить.\n\nВаша история становится легендой среди сотрудников спецслужб.`;
            break;
        case 'truth_seeker':
            title = "ПРАВДОИСКАТЕЛЬ";
            text = `Вы лично доставили документы в Москву, рискуя свободой.\n\nГенерал Соколов начинает масштабное расследование. Проект «ОКО-12» закрыт.\n\nНо вас увольняют за нарушение субординации. Вы возвращаетесь к обычной жизни в Москве.\n\nПравда стала достоянием узкого круга. Система не сломана, но ранена.\n\nПо ночам вам всё ещё снится фиолетовый свет над полигоном...`;
            break;
        case 'traitor':
            title = "ИЗМЕННИК РОДИНЫ";
            text = `Вы передали документы западным журналистам.\n\nМеждународный скандал! СССР обвиняют в бесчеловечных экспериментах.\n\nВас арестовывают за шпионаж. Суд: 15 лет лагерей.\n\nАтом-5 полностью закрывают, жителей расселяют. Правда похоронена под пропагандой.\n\nВы в лагере. Орлов в соседнем бараке. Он говорит: «Хотели как лучше...»\n\nИсторию переписывают. Вы — предатель.`;
            break;
        case 'keeper':
            title = "ХРАНИТЕЛЬ ТАЙНЫ";
            text = `Вы спрятали документы и ждали.\n\nГоды шли. 1991 год. СССР распался. Архивы открылись.\n\nВы опубликовали правду. Но страну разрывал кризис, всем было не до старой истории.\n\nАтом-5 стал городом-призраком. Вы жили там до старости, храня тайну.\n\nПеред смертью написали мемуары. Их нашли через год после вашей смерти...\n\nПравда стала достоянием истории. С опозданием на десятилетия.`;
            break;
        case 'complete':
            title = "ПУТЕШЕСТВИЕ ЗАВЕРШЕНО";
            text = `Вы прошли все главы истории об Атом-5.\n\nВаш итоговый уровень доверия: ${gameState.karma}\nДокументов собрано: ${gameState.documents}\nРешений принято: ${gameState.totalChoices}\n\nГород Атом-5 останется в вашей памяти как символ закрытости, страха и поиска правды в мире, где правда — опасна.\n\nСпасибо за игру.`;
            break;
        default:
            title = "КОНЕЦ ИГРЫ";
            text = "История завершена.";
    }
    
    if (elements.endingTitle) elements.endingTitle.textContent = title;
    if (elements.endingText) elements.endingText.textContent = text;
    
    if (elements.endingStats) {
        elements.endingStats.innerHTML = `
            <h3>Итоговая статистика</h3>
            <p>Доверие системы: <strong>${gameState.karma}</strong></p>
            <p>Секретных документов: <strong>${gameState.documents}</strong></p>
            <p>Принято решений: <strong>${gameState.totalChoices}</strong></p>
            <p>Ключевых предметов: <strong>${gameState.keyItems.length}</strong></p>
        `;
    }
    
    showScreen('ending-screen');
}

// Перезапустить игру
function restartGame() {
    startGame();
}

// Тёмный режим
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const btn = document.querySelector('button[onclick*="toggleDarkMode"]');
    if (btn) {
        if (document.body.classList.contains('dark-mode')) {
            btn.textContent = "РЕЖИМ: ТЁМНЫЙ";
        } else {
            btn.textContent = "РЕЖИМ: СТАНДАРТ";
        }
    }
}

// Обновить отображение статистики
function updateStatsDisplay() {
    // Можно добавить сохранение статистики между сессиями
    // localStorage.setItem('atom5_stats', JSON.stringify(gameState));
}

// ========== ИНИЦИАЛИЗАЦИЯ ==========
window.onload = function() {
    showMenu();
    
    // Запретить контекстное меню
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        return false;
    });
    
    // Быстрые клавиши для отладки
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            console.log("Состояние игры:", gameState);
            alert("Состояние игры сохранено в консоли");
        }
    });
    
    console.log("АТОМ-5: Визуальная новелла загружена.");
    console.log("Доступные главы:", chapters.length);
    console.log("Управление: мышь, клавиатура для отладки (Ctrl+S)");
}
// ========== СИСТЕМА ИЗОБРАЖЕНИЙ ==========
function showImage(imageUrl, duration = 3000) {
    // Создаем контейнер для изображения
    const imageContainer = document.createElement('div');
    imageContainer.id = 'fullscreen-image';
    imageContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.5s;
    `;
    
    // Создаем изображение
    const img = document.createElement('img');
    img.src = imageUrl;
    img.style.cssText = `
        max-width: 90%;
        max-height: 90%;
        border: 2px solid #00a8ff;
        box-shadow: 0 0 30px rgba(0, 168, 255, 0.5);
        border-radius: 5px;
        object-fit: contain;
    `;
    
    imageContainer.appendChild(img);
    document.body.appendChild(imageContainer);
    
    // Автоматическое скрытие через указанное время
    if (duration > 0) {
        setTimeout(() => {
            hideImage();
        }, duration);
    }
    
    // Закрытие по клику
    imageContainer.addEventListener('click', hideImage);
}

function hideImage() {
    const imageContainer = document.getElementById('fullscreen-image');
    if (imageContainer) {
        imageContainer.style.animation = 'fadeOut 0.5s';
        setTimeout(() => {
            if (imageContainer.parentNode) {
                imageContainer.parentNode.removeChild(imageContainer);
            }
        }, 500);
    }
}

// Добавляем анимации в CSS (если их нет)
function addImageAnimations() {
    if (!document.querySelector('#image-animations')) {
        const style = document.createElement('style');
        style.id = 'image-animations';
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
}
// ========== ОБРАБОТКА КОМАНД В ТЕКСТЕ ==========
function processTextCommands(text) {
    let processedText = text;
    
    // Обработка изображений [[IMG:путь]]
    const imgRegex = /\[\[IMG:(.*?)\]\]/g;
    const imgMatches = [...text.matchAll(imgRegex)];
    
    imgMatches.forEach((match, index) => {
        const imageUrl = match[1].trim();
        processedText = processedText.replace(match[0], `\n["ФОТО № ${index + 1}"]\n`);
        
        // Показываем изображение с задержкой
        setTimeout(() => {
            showImage(imageUrl, 4000);
        }, 1000 + (index * 500)); // Разная задержка для нескольких изображений
    });
    
    return processedText;
}
// Инициализация при загрузке
addImageAnimations();

// Экспорт для отладки
window.gameState = gameState;
window.chapters = chapters;
